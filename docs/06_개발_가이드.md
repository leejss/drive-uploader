# 개발 가이드

## 개발 환경 설정

### 사전 요구사항

- **Go**: 1.24.0 이상
- **Git**: 버전 관리
- **텍스트 에디터**: VS Code, GoLand 등 (Go 확장 권장)

### 개발 환경 구축

```bash
# 1. 리포지토리 클론
git clone https://github.com/leejss/drive-uploader.git
cd drive-uploader

# 2. Go 모듈 의존성 설치
go mod download

# 3. 개발 도구 설치
go install golang.org/x/tools/cmd/goimports@latest
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
go install github.com/air-verse/air@latest  # 핫 리로드
```

### VS Code 설정

`.vscode/settings.json`:
```json
{
    "go.toolsManagement.checkForUpdates": "local",
    "go.useLanguageServer": true,
    "go.gopath": "",
    "go.goroot": "",
    "go.formatTool": "goimports",
    "go.lintTool": "golangci-lint",
    "go.lintOnSave": "package",
    "go.testOnSave": true,
    "go.coverOnSave": true,
    "go.coverageDecorator": {
        "type": "gutter",
        "coveredHighlightColor": "rgba(64,128,64,0.5)",
        "uncoveredHighlightColor": "rgba(128,64,64,0.25)"
    }
}
```

## 프로젝트 구조 이해

### 디렉토리 구조

```
drive-uploader/
├── cmd/                          # 애플리케이션 진입점
│   └── drive-uploader/           # 메인 실행 파일
│       ├── main.go              # 메인 함수 및 CLI 로직
│       └── auth_helpers.go      # 인증 관련 헬퍼 함수
├── internal/                     # 내부 패키지 (외부 노출 안됨)
│   ├── config/                   # 설정 관리
│   │   └── config.go            # 설정 구조체 및 로드 함수
│   └── gdrive/                   # Google Drive API 연동
│       └── gdrive.go            # Drive 서비스 및 업로드 함수
├── docs/                         # 문서
├── test/                         # 테스트 파일 (향후 추가)
├── scripts/                      # 빌드 및 배포 스크립트 (향후 추가)
├── go.mod                        # Go 모듈 정의
├── go.sum                        # 의존성 버전 고정
└── README.md                     # 프로젝트 설명
```

### 패키지 책임

- **cmd**: 애플리케이션 실행 및 CLI 인터페이스
- **internal/config**: 환경 변수 및 설정 관리
- **internal/gdrive**: Google Drive API와의 상호작용

## 코드 스타일 가이드

### Go 포맷팅

```bash
# 코드 포맷팅
go fmt ./...

# import 정리
goimports -w .
```

### 명명 규칙

- **패키지**: 소문자, 짧고 의미 있는 이름
- **상수**: 대문자와 언더스코어 (MAX_FILE_SIZE)
- **변수/함수**: 카멜 케이스 (uploadFile, getService)
- **내보내기**: 대문자로 시작 (NewService, UploadFile)
- **비내보내기**: 소문자로 시작 (tokenFromFile, getClient)

### 에러 핸들링

```go
// 좋은 예
func UploadFile(srv *drive.Service, filePath string) (*drive.File, error) {
    file, err := os.Open(filePath)
    if err != nil {
        return nil, fmt.Errorf("failed to open file: %w", err)
    }
    defer file.Close()
    
    // ... 업로드 로직
    
    return uploadedFile, nil
}

// 나쁜 예 (에러 무시)
func UploadFile(srv *drive.Service, filePath string) (*drive.File, error) {
    file, _ := os.Open(filePath)  // 에러 무시
    defer file.Close()
    
    // ... 업로드 로직
    
    return uploadedFile, nil
}
```

## 개발 워크플로우

### 1. 기능 개발 단계

```bash
# 1. 기능 브랜치 생성
git checkout -b feature/folder-upload

# 2. 코드 개발
# ... 코드 작성

# 3. 테스트 실행
go test ./...

# 4. 코드 포맷팅 및 린트
go fmt ./...
golangci-lint run

# 5. 커밋
git add .
git commit -m "feat: add folder upload functionality"

# 6. 푸시 및 PR 생성
git push origin feature/folder-upload
```

### 2. 핫 리로드 개발

```bash
# air 설정 파일 생성
air init

# 개발 서버 시작
air
```

`.air.toml` 설정 예시:
```toml
root = "."
testdata_dir = "testdata"
tmp_dir = "tmp"

[build]
  args_bin = []
  bin = "./tmp/main"
  cmd = "go build -o ./tmp/main ./cmd/drive-uploader"
  delay = 1000
  exclude_dir = ["assets", "tmp", "vendor", "testdata"]
  exclude_file = []
  exclude_regex = ["_test.go"]
  exclude_unchanged = false
  follow_symlink = false
  full_bin = ""
  include_dir = []
  include_ext = ["go", "tpl", "tmpl", "html"]
  include_file = []
  kill_delay = "0s"
  log = "build-errors.log"
  poll = false
  poll_interval = 0
  rerun = false
  rerun_delay = 500
  send_interrupt = false
  stop_on_root = false

[color]
  app = ""
  build = "yellow"
  main = "magenta"
  runner = "green"
  watcher = "cyan"

[log]
  main_only = false
  time = false

[misc]
  clean_on_exit = false

[screen]
  clear_on_rebuild = false
  keep_scroll = true
```

## 테스트 작성

### 단위 테스트

```go
// internal/gdrive/gdrive_test.go
package gdrive

import (
    "context"
    "testing"
    "drive/v3"
)

func TestNewService(t *testing.T) {
    ctx := context.Background()
    
    // 테스트용 credentials 경로
    testCreds := "test-credentials.json"
    testToken := "test-token.json"
    
    // Mock 서비스 생성 (향후 구현)
    srv, err := NewService(ctx, testCreds, testToken)
    
    if err != nil {
        t.Fatalf("Expected no error, got %v", err)
    }
    
    if srv == nil {
        t.Fatal("Expected service, got nil")
    }
}

func TestUploadFile(t *testing.T) {
    // Mock 서비스 생성
    srv := &drive.Service{} // 실제로는 mock 사용
    
    // 테스트용 파일 생성
    testFile := "test-upload.txt"
    
    uploadedFile, err := UploadFile(srv, testFile)
    
    if err != nil {
        t.Fatalf("Expected no error, got %v", err)
    }
    
    if uploadedFile == nil {
        t.Fatal("Expected uploaded file, got nil")
    }
    
    if uploadedFile.Name != testFile {
        t.Errorf("Expected file name %s, got %s", testFile, uploadedFile.Name)
    }
}
```

### 통합 테스트

```go
// test/integration_test.go
// +build integration

package test

import (
    "context"
    "os"
    "testing"
    "github.com/leejss/drive-uploader/internal/gdrive"
)

func TestRealUpload(t *testing.T) {
    if testing.Short() {
        t.Skip("Skipping integration test in short mode")
    }
    
    ctx := context.Background()
    
    // 실제 credentials 사용
    srv, err := gdrive.NewService(ctx, "credentials.json", "token.json")
    if err != nil {
        t.Fatalf("Failed to create service: %v", err)
    }
    
    // 테스트 파일 생성
    testContent := "Integration test content"
    testFile := "integration-test.txt"
    
    err = os.WriteFile(testFile, []byte(testContent), 0644)
    if err != nil {
        t.Fatalf("Failed to create test file: %v", err)
    }
    defer os.Remove(testFile)
    
    // 실제 업로드 테스트
    uploadedFile, err := gdrive.UploadFile(srv, testFile)
    if err != nil {
        t.Fatalf("Failed to upload file: %v", err)
    }
    
    if uploadedFile.Name != testFile {
        t.Errorf("Expected file name %s, got %s", testFile, uploadedFile.Name)
    }
    
    // 업로드된 파일 정리 (필요시)
    // gdrive.DeleteFile(srv, uploadedFile.Id)
}
```

### 테스트 실행

```bash
# 모든 테스트 실행
go test ./...

# 상세한 테스트 결과
go test -v ./...

# 특정 패키지 테스트
go test -v ./internal/gdrive

# 커버리지 확인
go test -cover ./...

# 커버리지 리포트 생성
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# 통합 테스트만 실행
go test -tags=integration ./test/...

# 단위 테스트만 실행 (통합 테스트 제외)
go test -short ./...
```

## 기능 확장 가이드

### 1. 새로운 명령어 추가

#### 단계 1: CLI 구조 개선

```go
// cmd/drive-uploader/root.go
package main

import (
    "github.com/spf13/cobra"
)

var rootCmd = &cobra.Command{
    Use:   "drive-uploader",
    Short: "Google Drive upload tool",
    Long:  "A command-line tool for uploading files to Google Drive",
}

func init() {
    rootCmd.AddCommand(uploadCmd)
    rootCmd.AddCommand(authCmd)
}

func main() {
    if err := rootCmd.Execute(); err != nil {
        log.Fatal(err)
    }
}
```

#### 단계 2: 서브커맨드 구현

```go
// cmd/drive-uploader/upload.go
package main

import (
    "github.com/spf13/cobra"
)

var uploadCmd = &cobra.Command{
    Use:   "upload [file]",
    Short: "Upload a file to Google Drive",
    Args:  cobra.ExactArgs(1),
    Run: func(cmd *cobra.Command, args []string) {
        filePath := args[0]
        // 업로드 로직 구현
        uploadFile(filePath)
    },
}

func init() {
    uploadCmd.Flags().StringP("folder", "f", "", "Destination folder ID")
}
```

### 2. 폴더 업로드 기능

```go
// internal/gdrive/folder.go
package gdrive

import (
    "os"
    "path/filepath"
)

func UploadFolder(srv *drive.Service, folderPath string) error {
    return filepath.Walk(folderPath, func(path string, info os.FileInfo, err error) error {
        if err != nil {
            return err
        }
        
        if !info.IsDir() {
            // 파일 업로드
            _, err := UploadFile(srv, path)
            if err != nil {
                return err
            }
        }
        
        return nil
    })
}
```

### 3. 설정 파일 지원

```go
// internal/config/config.go 확장
type Config struct {
    TokenFilePath    string `json:"token_file_path"`
    CredentialsPath  string `json:"credentials_path"`
    DefaultFolderID  string `json:"default_folder_id"`
    ChunkSize        int64  `json:"chunk_size"`
    MaxRetries       int    `json:"max_retries"`
}

func LoadFromFile(path string) (*Config, error) {
    data, err := os.ReadFile(path)
    if err != nil {
        return nil, err
    }
    
    var cfg Config
    if err := json.Unmarshal(data, &cfg); err != nil {
        return nil, err
    }
    
    return &cfg, nil
}
```

## 디버깅

### 1. 로깅 설정

```go
// internal/logger/logger.go
package logger

import (
    "log"
    "os"
)

type Logger struct {
    debug bool
    info  bool
    error bool
}

func New(debug bool) *Logger {
    return &Logger{
        debug: debug,
        info:  true,
        error: true,
    }
}

func (l *Logger) Debug(format string, v ...interface{}) {
    if l.debug {
        log.Printf("[DEBUG] "+format, v...)
    }
}

func (l *Logger) Info(format string, v ...interface{}) {
    if l.info {
        log.Printf("[INFO] "+format, v...)
    }
}

func (l *Logger) Error(format string, v ...interface{}) {
    if l.error {
        log.Printf("[ERROR] "+format, v...)
    }
}
```

### 2. 디버그 모드

```bash
# 디버그 모드로 실행
DEBUG=1 go run ./cmd/drive-uploader -file test.txt

# 상세 로그 출력
VERBOSE=1 go run ./cmd/drive-uploader -file test.txt
```

### 3. Delve 디버거 사용

```bash
# Delve 설치
go install github.com/go-delve/delve/cmd/dlv@latest

# 디버깅 시작
dlv debug ./cmd/drive-uploader -- -file test.txt

# 또는
dlv debug --headless --listen=:2345 --api-version=2 ./cmd/drive-uploader
```

## 성능 최적화

### 1. 동시 업로드

```go
// internal/gdrive/concurrent.go
package gdrive

import (
    "sync"
)

func UploadFiles(srv *drive.Service, filePaths []string) error {
    var wg sync.WaitGroup
    errChan := make(chan error, len(filePaths))
    
    for _, filePath := range filePaths {
        wg.Add(1)
        go func(fp string) {
            defer wg.Done()
            _, err := UploadFile(srv, fp)
            if err != nil {
                errChan <- err
            }
        }(filePath)
    }
    
    wg.Wait()
    close(errChan)
    
    for err := range errChan {
        if err != nil {
            return err
        }
    }
    
    return nil
}
```

### 2. 청크 업로드

```go
// internal/gdrive/chunked.go
package gdrive

import (
    "google.golang.org/api/googleapi"
)

func UploadChunked(srv *drive.Service, filePath string, chunkSize int64) (*drive.File, error) {
    file, err := os.Open(filePath)
    if err != nil {
        return nil, err
    }
    defer file.Close()
    
    fileInfo, err := file.Stat()
    if err != nil {
        return nil, err
    }
    
    media := &googleapi.Media{
        Size: fileInfo.Size(),
    }
    
    // 청크 업로드 로직 구현
    // ...
    
    return uploadedFile, nil
}
```

## 배포

### 1. 빌드 스크립트

```bash
#!/bin/bash
# scripts/build.sh

set -e

VERSION=$(git describe --tags --always --dirty)
LDFLAGS="-X main.version=$VERSION -X main.buildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

# 크로스 컴파일
GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o bin/drive-uploader-linux-amd64 ./cmd/drive-uploader
GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o bin/drive-uploader-darwin-amd64 ./cmd/drive-uploader
GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o bin/drive-uploader-windows-amd64.exe ./cmd/drive-uploader

echo "Build completed: $VERSION"
```

### 2. GitHub Actions

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.24.0
    
    - name: Build
      run: |
        chmod +x scripts/build.sh
        ./scripts/build.sh
    
    - name: Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
```

## 기여 가이드

### 1. 이슈 보고

- **버그 리포트**: 재현 단계, 환경 정보, 에러 로그 포함
- **기능 요청**: 사용 사례, 예상 동작 상세 설명

### 2. 풀 리퀘스트

- **브랜치 명명**: `feature/기능명`, `bugfix/버그명`
- **커밋 메시지**: [Conventional Commits](https://www.conventionalcommits.org/) 따르기
- **테스트**: 새로운 기능에 대한 테스트 코드 포함
- **문서**: 변경사항에 대한 문서 업데이트

### 3. 코드 리뷰

- **자가 검토**: PR 생성 전 스스로 코드 검토
- **동료 검토**: 최소 1명 이상의 리뷰어 승인 필요
- **CI/CD**: 모든 체크 통과 필요

이 개발 가이드를 통해 Drive Uploader 프로젝트에 기여해주셔서 감사합니다!
